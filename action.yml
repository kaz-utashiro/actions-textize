ame: textize documents

inputs:
  root:   { required: false, type: string }
  branch: { required: false, type: string, default: textize }
  token:  { required: true, default: '${{ github.token }}' }

runs:
  using: composite
  steps:

    - uses: office-tecoli/actions-use-any-tools@v0
      with:
        perl: App::optex::textconv
        apt:  poppler-utils

    - uses: actions/checkout@v2
      with:
        ref: ${{ inputs.branch }}
        path: __textize__

    - id: textize
      shell: bash
      run: |
        : textize
        root=${{ inputs.root }}
        : ${root:=.}
        textize=$GITHUB_ACTION_PATH/textize.sh
        files=$(git ls-files $root)
        echo Processing $files ...
        update=$( $textize $files )
        echo Update: $update
        cat << END
        ::set-output name=update::$update
        END
        #
        set -x; exec 2>&1
        git config --global user.email "$GITHUB_ACTOR@users.noreply.github.com>"
        git config --global user.name "$GITHUB_ACTOR"
        git branch -av
        (
            cd __textize__
            git fetch origin $GITHUB_REF_NAME || :
            git merge \
                --allow-unrelated-histories \
                -m "merge origin/$GITHUB_REF_NAME" \
                -s ort -X theirs \
                origin/$GITHUB_REF_NAME || : \
        )
        tar -cf - $update | tar -C __textize__ -xvf -

    - id: export
      shell: bash
      run: |
        : export
        set -x; exec 2>&1
        cd __textize__
        update="${{ steps.textize.outputs.update }}"
        TOKEN="${{ inputs.token }}"
        repo="https://${GITHUB_ACTOR}:${TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
        git add .
        if git commit -m "update $update"
        then
            git push
        fi
